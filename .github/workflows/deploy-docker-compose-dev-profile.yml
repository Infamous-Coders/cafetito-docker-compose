name: Deploy Docker Compose Dev Profile

on:
  push:
    branches:
      - develop
    paths:
      - 'dev/docker-compose.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Instalar Cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
      - name: Configurar clave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
      - name: Crear archivo SSH config con Cloudflared
        run: |
          cat <<EOF > ~/.ssh/config
          Host sshserver
            HostName ${{ secrets.DOMAIN }}
            User ${{ secrets.USERNAME }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            ProxyCommand cloudflared access ssh --hostname %h
          EOF
          chmod 600 ~/.ssh/config
      - name: Ejecutar comandos en el servidor remoto
        run: |
          ssh sshserver << 'EOF'
          
          set -e
          
          echo "ðŸ“¦ Cambiando al repositorio..."
          cd /mnt/nvme01/cafetito/repositories
          
          if [ ! -d "cafetito-docker-compose" ]; then
          
            git clone git@github.com:Infamous-Coders/cafetito-docker-compose.git
            echo "âœ… Repositorio clonado."
            cd cafetito-docker-compose
          
          else
          
            echo "âœ… El repositorio ya existe."
            cd cafetito-docker-compose
          
            echo "ðŸ—‚ï¸ Haciendo backup temporal..."  
            cp -r dev dev_backup_$(date +%s)
          fi
          
          PREVIOUS_COMMIT=$(git rev-parse HEAD)
          echo "ðŸ”½ Actualizando a la Ãºltima versiÃ³n el repositorio..."
          git fetch origin develop || {
            echo "âŒ Error al actualizar el repositorio. Abortando."
            exit 1
          }
          git switch develop
          
          CHANGED=$(git diff --name-only HEAD origin/develop)
          echo "âœ… Repositorio actualizado."
          
          if [ -z "$CHANGED" ]; then
          echo "âœ… No hay cambios para aplicar. Fin del proceso."
          exit 0
          fi
          
          cd dev
          
          echo "ðŸ§¹ Bajando contenedores actuales..."
          sudo docker compose down
          
          echo "ðŸš€ Levantando nuevos contenedores..."
          if ! sudo docker compose up -d; then
            echo "âŒ Docker Compose fallÃ³. Haciendo rollback..."
          
          # Rollback del cÃ³digo
          cd ..
          git reset --hard "$PREVIOUS_COMMIT"
          rm -rf dev
          mv dev_backup_* dev
          
          # Rollback de contenedores
          cd dev
          sudo docker compose up -d || {
          echo "ðŸ”¥ Rollback tambiÃ©n fallÃ³. RevisiÃ³n manual requerida."
          exit 1
          }
          
          echo "âœ… Rollback exitoso."
          exit 1
          fi
          
          echo "âœ… Deploy finalizado con Ã©xito."
          
          EOF